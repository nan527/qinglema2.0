<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签字区域</title>
    <style>
        .signature-container {
            width: 600px;
            height: 300px;
            border: 2px dashed #ccc;
            position: relative;
            margin: 20px auto;
        }
        #signatureCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .controls {
            text-align: center;
            margin: 10px;
        }
        button {
            padding: 8px 16px;
            margin: 0 5px;
            cursor: pointer;
        }
        .back-btn {
            margin: 20px auto;
            display: block;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .back-btn:hover {
            background-color: #4b5563;
        }
    </style>
</head>
<body>
    <!-- 修正：返回辅导员页面的路径，点击返回时清除临时数据 -->
    <button class="back-btn" onclick="clearTempDataAndReturn()">
        <i class="fa fa-arrow-left mr-1"></i>返回审批页
    </button>
    
    <div class="signature-container">
        <canvas id="signatureCanvas"></canvas>
    </div>
    <div class="controls">
        <button id="clearBtn">清除签字</button>
        <button id="saveBtn">保存签字</button>
    </div>

    <script>
        // 获取Canvas元素和上下文
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        
        // 设置Canvas尺寸
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // 签字相关变量
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        
        // 开始绘制
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
        }
        
        // 绘制中
        function draw(e) {
            if (!isDrawing) return;
            
            const [x, y] = getPosition(e);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }
        
        // 结束绘制
        function stopDrawing() {
            isDrawing = false;
        }
        
        // 获取鼠标/触摸位置
        function getPosition(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.type.includes('mouse')) {
                return [e.clientX - rect.left, e.clientY - rect.top];
            } else {
                // 支持触摸设备
                return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
            }
        }
        
        // 清除签字
        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // 保存签字并完成审批
        function saveSignature() {
            const dataURL = canvas.toDataURL('image/png');
            
            // 获取之前存储的请假批准信息
            const pendingApproval = localStorage.getItem('pending_leave_approval');
            
            if (!pendingApproval) {
                alert('未找到待批准信息，请重新操作');
                window.location.href = '/counselor';
                return;
            }
            
            const approvalData = JSON.parse(pendingApproval);
            
            // 发送到后端保存签字，使用leave_id作为文件名
            fetch('/api/save_signature', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    imageData: dataURL,
                    fileName: `signature_${approvalData.leave_id}.png`
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 签字保存成功后，调用批准API并携带签字路径和leave_id
                    return fetch('/api/counselor/approve_leave', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            leave_id: approvalData.leave_id,
                            action: approvalData.action,
                            comment: approvalData.comment,
                            signature_path: data.imagePath,
                            leave_id_for_signature: approvalData.leave_id  // 额外传递leave_id以确保签名与假条关联
                        })
                    });
                } else {
                    throw new Error('保存签字失败: ' + data.message);
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 清除临时存储的数据
                    localStorage.removeItem('pending_leave_approval');
                    
                    alert('请假已成功批准，即将返回审批页');
                    // 跳转回辅导员页面
                    window.location.href = '/counselor';
                } else {
                    throw new Error('批准失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('操作失败:', error);
                alert('操作失败: ' + error.message);
            });
        }
        
        // 事件监听
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // 触摸设备支持
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDrawing(e);
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e);
        });
        canvas.addEventListener('touchend', stopDrawing);
        
        // 按钮事件
        document.getElementById('clearBtn').addEventListener('click', clearSignature);
        document.getElementById('saveBtn').addEventListener('click', saveSignature);
        
        // 清除临时数据并返回审批页
        function clearTempDataAndReturn() {
            // 清除localStorage中的临时数据
            localStorage.removeItem('pending_leave_approval');
            // 返回审批页
            window.location.href = '/counselor';
        }
    </script>
</body>
</html>