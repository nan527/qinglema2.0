<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>教师工作台 - 请假管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#F59E0B',
            'primary-light': '#FBBF24',
            'primary-dark': '#D97706',
            accent: '#F97316',
            surface: '#FFFBEB',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444'
          },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'slide-up': 'slideUp 0.5s ease-out',
            'fade-in': 'fadeIn 0.6s ease-out',
            'scaleIn': 'scaleIn 0.3s ease-out'
          }
        }
      }
    };
  </script>

  <style>
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    @keyframes glow { from { box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); } to { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    
    .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); }
    .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); }
    .gradient-border { position: relative; background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(249,115,22,0.1)); }
    .gradient-border::before { content: ''; position: absolute; inset: 0; border-radius: inherit; padding: 1px; background: linear-gradient(135deg, #F59E0B, #F97316); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
    .shimmer { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); background-size: 200% 100%; animation: shimmer 2s infinite; }
    .hover-lift { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(245, 158, 11, 0.15); }
    .btn-glow { position: relative; overflow: hidden; }
    .btn-glow::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); transform: rotate(45deg); transition: all 0.6s; opacity: 0; }
    .btn-glow:hover::after { animation: shimmer 1.5s; opacity: 1; }
    .animate-in { animation: slideUp 0.5s ease-out forwards; }
    .animate-scaleIn { animation: scaleIn 0.3s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    .mesh-gradient { background: radial-gradient(at 40% 20%, rgba(245, 158, 11, 0.08) 0px, transparent 50%), radial-gradient(at 80% 0%, rgba(249, 115, 22, 0.08) 0px, transparent 50%), radial-gradient(at 0% 50%, rgba(245, 158, 11, 0.05) 0px, transparent 50%), radial-gradient(at 80% 50%, rgba(249, 115, 22, 0.05) 0px, transparent 50%), radial-gradient(at 0% 100%, rgba(245, 158, 11, 0.08) 0px, transparent 50%), linear-gradient(180deg, #FFFBEB 0%, #FEF3C7 100%); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #F59E0B, #F97316); border-radius: 10px; }
    .text-gradient { background: linear-gradient(135deg, #F59E0B, #D97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .badge-pending { background: linear-gradient(135deg, #FEF3C7, #FDE68A); color: #92400E; }
    .badge-approved { background: linear-gradient(135deg, #D1FAE5, #A7F3D0); color: #065F46; }
    .badge-rejected { background: linear-gradient(135deg, #FEE2E2, #FECACA); color: #991B1B; }
    
    /* 吉祥物动画 */
    @keyframes mascotFloat { 0%, 100% { transform: translateY(0) rotate(-2deg); } 50% { transform: translateY(-12px) rotate(2deg); } }
    .mascot-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; cursor: pointer; transition: all 0.3s ease; }
    .mascot-container:hover { transform: scale(1.1); }
    .mascot-container:hover .mascot-bubble { opacity: 1; transform: translateX(0) scale(1); }
    .mascot-img { width: 90px; height: auto; animation: mascotFloat 4s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(245, 158, 11, 0.3)); transition: filter 0.3s ease; }
    .mascot-container:hover .mascot-img { filter: drop-shadow(0 15px 30px rgba(245, 158, 11, 0.5)); }
    .mascot-bubble { position: absolute; bottom: 80%; right: 60%; background: white; padding: 8px 14px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 13px; color: #F59E0B; font-weight: 500; white-space: nowrap; opacity: 0; transform: translateX(10px) scale(0.9); transition: all 0.3s ease; }
    .mascot-bubble::after { content: ''; position: absolute; bottom: -6px; right: 20px; width: 12px; height: 12px; background: white; transform: rotate(45deg); box-shadow: 3px 3px 5px rgba(0,0,0,0.05); }
    @media (max-width: 640px) { .mascot-container { bottom: 10px; right: 10px; } .mascot-img { width: 60px; } .mascot-bubble { font-size: 11px; padding: 6px 10px; } }
  </style>
</head>

<body class="font-sans mesh-gradient min-h-screen text-gray-700">
  <!-- AI助手吉祥物 -->
  <div class="mascot-container" id="mascot">
    <div class="mascot-bubble" id="mascotBubble">有问题问我~</div>
    <img src="/static/images/mascot.png" alt="小龙助手" class="mascot-img" draggable="false">
  </div>

  <!-- AI对话框 -->
  <div id="aiChatBox" class="fixed bottom-28 right-6 w-80 glass-card rounded-2xl shadow-2xl z-50 hidden transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
    <div class="bg-gradient-to-r from-primary to-accent text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
      <div class="flex items-center">
        <i class="fa-solid fa-robot mr-2"></i>
        <span class="font-medium">小龙助手</span>
        <span class="ml-2 text-xs bg-white/20 px-2 py-0.5 rounded-full">AI</span>
      </div>
      <button onclick="event.stopPropagation(); toggleAiChat()" class="w-7 h-7 rounded-lg hover:bg-white/20 flex items-center justify-center transition-all">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div id="aiChatMessages" class="h-80 overflow-y-auto p-4 space-y-3 custom-scrollbar">
      <div class="flex items-start space-x-2">
        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
          <i class="fa-solid fa-dragon text-primary text-sm"></i>
        </div>
        <div class="bg-gray-100 rounded-2xl rounded-tl-none px-4 py-2 max-w-[80%]">
          <p class="text-sm text-gray-700">你好老师！我是小龙，有什么可以帮您的吗？</p>
        </div>
      </div>
    </div>
    <div class="p-3 border-t border-gray-100" onclick="event.stopPropagation()">
      <div class="flex items-center space-x-2">
        <input type="text" id="aiChatInput" placeholder="输入问题..." class="flex-1 px-4 py-2 rounded-xl border border-gray-200 focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-sm" onkeypress="if(event.key==='Enter'){event.stopPropagation();sendAiMessage()}" onclick="event.stopPropagation()">
        <button onclick="event.stopPropagation(); sendAiMessage()" id="aiSendBtn" class="w-10 h-10 rounded-xl bg-primary text-white hover:bg-primary-dark transition-all flex items-center justify-center">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- 顶部导航 -->
  <header class="glass-nav sticky top-0 z-50 border-b border-white/50 shadow-lg shadow-primary/5">
    <div class="container mx-auto px-6 py-3">
      <div class="flex justify-between items-center">
        <!-- Logo区域 -->
        <div class="flex items-center space-x-3">
          <img src="/static/images/logo.png" alt="请了吗" class="w-11 h-11 object-contain">
          <div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-purple-400 bg-clip-text text-transparent">请了吗</h1>
            <p class="text-xs text-gray-400 font-medium tracking-wide">教师工作台</p>
          </div>
        </div>
        
        <!-- 导航菜单 -->
        <nav class="hidden md:flex items-center bg-white/50 rounded-2xl p-1.5 shadow-inner">
          <button onclick="switchTab('leaves')" id="tab-leaves" class="nav-tab px-5 py-2.5 rounded-xl text-primary bg-white shadow-md text-sm font-medium flex items-center space-x-2">
            <i class="fa-solid fa-clipboard-list"></i><span>学生请假</span>
          </button>
          <button onclick="switchTab('chat')" id="tab-chat" class="nav-tab px-5 py-2.5 rounded-xl text-gray-600 hover:text-primary hover:bg-white hover:shadow-md transition-all duration-300 text-sm font-medium flex items-center space-x-2">
            <i class="fa-solid fa-comments"></i><span>学生聊天</span>
          </button>
          <button onclick="switchTab('notification')" id="tab-notification" class="nav-tab px-5 py-2.5 rounded-xl text-gray-600 hover:text-primary hover:bg-white hover:shadow-md transition-all duration-300 text-sm font-medium flex items-center space-x-2">
            <i class="fa-solid fa-bell"></i><span>我的通知</span>
          </button>
          <button onclick="switchTab('profile')" id="tab-profile" class="nav-tab px-5 py-2.5 rounded-xl text-gray-600 hover:text-primary hover:bg-white hover:shadow-md transition-all duration-300 text-sm font-medium flex items-center space-x-2">
            <i class="fa-solid fa-user-gear"></i><span>个人信息</span>
          </button>
        </nav>
        
        <!-- 用户信息 -->
        <div class="flex items-center space-x-3">
          <div class="flex items-center space-x-3 px-4 py-2 rounded-2xl glass-card hover-lift group cursor-pointer">
            <div class="relative">
              <div id="navAvatar" class="w-11 h-11 rounded-xl bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-lg shadow-lg overflow-hidden">
                {{ user_info.user_name[0] if user_info.user_name else 'T' }}
              </div>
              <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div class="hidden sm:block">
              <p class="text-sm font-bold text-gray-800">{{ user_info.user_name }}</p>
              <p class="text-xs text-primary font-medium">讲师</p>
            </div>
          </div>
          <button onclick="handleLogout()" class="w-10 h-10 rounded-xl glass-card flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all duration-300 hover:scale-105" title="退出登录">
            <i class="fa-solid fa-power-off"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Toast提示 -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 transition-opacity opacity-0 pointer-events-none"></div>

  <!-- 主内容区 -->
  <main class="container mx-auto px-6 py-10 max-w-6xl">
    <!-- 页面标题 -->
    <div class="mb-10 animate-in">
      <div class="flex items-center space-x-3 mb-2">
        <div class="w-1.5 h-8 bg-gradient-to-b from-primary to-accent rounded-full"></div>
        <h2 id="pageTitle" class="text-3xl font-bold bg-gradient-to-r from-gray-800 via-gray-700 to-gray-600 bg-clip-text text-transparent">学生请假记录</h2>
      </div>
      <p id="pageSubtitle" class="text-gray-500 ml-5">查看和管理您所授课程的学生请假申请</p>
    </div>

    <!-- 学生请假记录页面 -->
    <div id="page-leaves" class="page-content">
      <!-- 请假记录列表 -->
      <div class="glass-card rounded-3xl overflow-hidden">
        <div class="p-6 border-b border-gray-100">
          <!-- 时间筛选 -->
          <div class="flex items-center flex-wrap gap-3 mb-4 pb-4 border-b border-gray-100">
            <div class="flex items-center space-x-2">
              <i class="fa-solid fa-calendar text-primary"></i>
              <span class="text-sm text-gray-600 font-medium">查询日期：</span>
            </div>
            <input type="date" id="filterDateStart" onchange="applyFilters()" class="px-3 py-2 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm">
            <span class="text-gray-400">至</span>
            <input type="date" id="filterDateEnd" onchange="applyFilters()" class="px-3 py-2 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm">
            <button onclick="setToday()" class="px-3 py-2 bg-blue-50 text-blue-600 rounded-xl text-sm hover:bg-blue-100 transition-all">今天</button>
            <button onclick="setThisWeek()" class="px-3 py-2 bg-purple-50 text-purple-600 rounded-xl text-sm hover:bg-purple-100 transition-all">本周</button>
            <button onclick="clearDateFilter()" class="px-3 py-2 bg-gray-50 text-gray-600 rounded-xl text-sm hover:bg-gray-100 transition-all">清除</button>
          </div>
          <!-- 课程到课统计 -->
          <div id="courseAttendanceStats" class="flex flex-wrap gap-3 mb-4">
            <div class="text-sm text-gray-400 py-2">加载课程统计中...</div>
          </div>
          <!-- 筛选操作栏 -->
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-center flex-wrap gap-3">
              <div class="flex items-center space-x-2 px-4 py-2 bg-green-50 rounded-xl">
                <i class="fa-solid fa-clipboard-check text-green-500"></i>
                <span class="text-sm text-gray-600">时段内请假</span>
                <span id="statTotal" class="font-bold text-green-600">0</span>
                <span class="text-sm text-gray-500">人</span>
              </div>
              <select id="courseFilter" onchange="applyFilters()" class="px-4 py-2 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm">
                <option value="">全部课程</option>
              </select>
              <input type="text" id="searchInput" placeholder="搜索学生姓名或学号..." oninput="renderLeaveRecords()" class="px-4 py-2 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary text-sm w-48">
            </div>
            <button onclick="loadLeaveRecords()" class="px-5 py-2 bg-gradient-to-r from-primary to-accent text-white rounded-xl text-sm font-medium shadow-lg hover:shadow-xl transition-all btn-glow">
              <i class="fa-solid fa-rotate mr-2"></i>刷新
            </button>
          </div>
        </div>
        
        <div id="leaveRecordsContainer" class="divide-y divide-gray-100 max-h-[600px] overflow-y-auto custom-scrollbar">
          <div class="p-8 text-center text-gray-400">
            <i class="fa-solid fa-spinner fa-spin text-2xl mb-3"></i>
            <p>加载中...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的通知页面 -->
    <div id="page-notification" class="page-content hidden">
      <!-- 统计卡片 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="glass-card rounded-2xl p-4 hover-lift">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">总通知</p>
              <p id="notifyStat1" class="text-2xl font-bold text-gray-800">0</p>
            </div>
            <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center">
              <i class="fa-solid fa-bell text-primary"></i>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-4 hover-lift">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">课程通知</p>
              <p id="notifyStat2" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
              <i class="fa-solid fa-book text-blue-600"></i>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-4 hover-lift">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">作业通知</p>
              <p id="notifyStat3" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="w-10 h-10 rounded-xl bg-green-100 flex items-center justify-center">
              <i class="fa-solid fa-file-pen text-green-600"></i>
            </div>
          </div>
        </div>
        <div class="glass-card rounded-2xl p-4 hover-lift">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-500">紧急通知</p>
              <p id="notifyStat4" class="text-2xl font-bold text-red-600">0</p>
            </div>
            <div class="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center">
              <i class="fa-solid fa-triangle-exclamation text-red-600"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <!-- 发送通知 -->
        <div class="lg:col-span-2 glass-card rounded-3xl p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
            <i class="fa-solid fa-paper-plane mr-3 text-primary"></i>发送通知
          </h3>
          <form id="notificationForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2"><i class="fa-solid fa-heading mr-2 text-primary"></i>通知标题</label>
              <input type="text" id="notifyTitle" placeholder="请输入通知标题" required class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2"><i class="fa-solid fa-tag mr-2 text-primary"></i>通知类型</label>
                <select id="notifyType" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                  <option value="课程通知">课程通知</option>
                  <option value="作业通知">作业通知</option>
                  <option value="考试通知">考试通知</option>
                  <option value="调课通知">调课通知</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-600 mb-2"><i class="fa-solid fa-flag mr-2 text-primary"></i>优先级</label>
                <select id="notifyPriority" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
                  <option value="普通">普通</option>
                  <option value="重要">重要</option>
                  <option value="紧急">紧急</option>
                </select>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2"><i class="fa-solid fa-book mr-2 text-primary"></i>关联课程（可选）</label>
              <input type="text" id="notifyCourse" placeholder="输入课程编号，如：001" class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2"><i class="fa-solid fa-pen mr-2 text-primary"></i>通知内容</label>
              <textarea id="notifyContent" rows="4" placeholder="请输入通知内容..." required class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all resize-none"></textarea>
            </div>
            
            <button type="submit" class="w-full py-4 bg-gradient-to-r from-primary to-accent text-white rounded-2xl font-medium shadow-lg shadow-primary/30 hover:shadow-xl hover:-translate-y-0.5 transition-all btn-glow">
              <i class="fa-solid fa-paper-plane mr-2"></i>发送通知
            </button>
          </form>
        </div>
        
        <!-- 已发送通知列表 -->
        <div class="lg:col-span-3 glass-card rounded-3xl p-6">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-xl font-bold text-gray-800 flex items-center">
              <i class="fa-solid fa-clock-rotate-left mr-3 text-primary"></i>已发送通知
            </h3>
            <div class="flex items-center space-x-2">
              <select id="notifyFilter" onchange="loadNotifications()" class="px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-primary/30">
                <option value="">全部类型</option>
                <option value="课程通知">课程通知</option>
                <option value="作业通知">作业通知</option>
                <option value="考试通知">考试通知</option>
                <option value="调课通知">调课通知</option>
              </select>
              <button onclick="loadNotifications()" class="px-3 py-1.5 bg-primary/10 text-primary rounded-lg text-sm hover:bg-primary/20 transition-all">
                <i class="fa-solid fa-rotate"></i>
              </button>
            </div>
          </div>
          <div id="notificationList" class="space-y-3 max-h-[550px] overflow-y-auto custom-scrollbar">
            <div class="p-4 text-center text-gray-400">
              <i class="fa-solid fa-spinner fa-spin text-xl mb-2"></i>
              <p>加载中...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 学生聊天页面 -->
    <div id="page-chat" class="page-content hidden">
      <div class="glass-card rounded-2xl overflow-hidden" style="height: 520px;">
        <div class="flex h-full">
          <!-- 学生列表 -->
          <div class="w-64 border-r border-gray-200 flex flex-col bg-white/50">
            <div class="p-3 border-b border-gray-100 flex items-center justify-between">
              <h3 class="font-bold text-gray-800 text-sm flex items-center">
                <i class="fa-solid fa-users mr-2 text-primary"></i>学生列表
              </h3>
              <button onclick="loadChatStudents()" class="p-1.5 hover:bg-primary/10 rounded-lg transition-all">
                <i class="fa-solid fa-rotate text-primary text-sm"></i>
              </button>
            </div>
            <div class="p-2">
              <input type="text" id="studentSearch" placeholder="搜索学生..." oninput="filterStudents()" class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-sm">
            </div>
            <div id="studentList" class="flex-1 overflow-y-auto custom-scrollbar">
              <div class="p-4 text-center text-gray-400 text-sm">
                <i class="fa-solid fa-spinner fa-spin"></i> 加载中...
              </div>
            </div>
          </div>
          
          <!-- 聊天区域 -->
          <div class="flex-1 flex flex-col">
            <!-- 聊天头部 -->
            <div class="p-3 border-b border-gray-100 flex items-center space-x-3 bg-white/50">
              <div id="chatAvatar" class="w-9 h-9 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center text-primary font-bold text-sm">?</div>
              <div>
                <p id="chatStudentName" class="font-bold text-gray-800 text-sm">选择学生开始聊天</p>
                <p id="chatStudentId" class="text-xs text-gray-400">--</p>
              </div>
            </div>
            
            <!-- 聊天消息区 -->
            <div id="chatMessages" class="flex-1 p-4 overflow-y-auto custom-scrollbar bg-gradient-to-b from-gray-50/30 to-white">
              <div class="text-center py-12 text-gray-400">
                <div class="w-16 h-16 mx-auto mb-3 rounded-xl bg-primary/10 flex items-center justify-center">
                  <i class="fa-solid fa-comments text-2xl text-primary/30"></i>
                </div>
                <p class="text-sm">选择一个学生开始聊天</p>
              </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="p-3 border-t border-gray-100 bg-white/50">
              <div class="flex space-x-2">
                <input type="text" id="chatInput" placeholder="选择学生后发送消息..." disabled class="flex-1 px-3 py-2 rounded-lg border border-gray-200 bg-white focus:ring-2 focus:ring-primary/30 focus:border-primary transition-all text-sm disabled:bg-gray-100 disabled:cursor-not-allowed" onkeypress="if(event.key==='Enter')sendChatMessage()">
                <button onclick="sendChatMessage()" id="chatSendBtn" disabled class="px-4 py-2 bg-gradient-to-r from-primary to-accent text-white rounded-lg font-medium shadow hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 个人信息页面 -->
    <div id="page-profile" class="page-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 左侧：个人信息 -->
        <div class="lg:col-span-2 space-y-6">
          <div class="glass-card rounded-3xl p-8 hover-lift">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fa-solid fa-user-circle mr-3 text-primary text-2xl"></i>个人信息
              </h3>
              <button onclick="showEditContact()" class="px-4 py-2 bg-primary/10 text-primary rounded-xl hover:bg-primary/20 transition-all text-sm font-medium">
                <i class="fa-solid fa-edit mr-2"></i>编辑联系方式
              </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-id-badge text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">工号</p>
                  <p class="text-lg font-bold text-gray-800">{{ user_info.user_account }}</p>
                </div>
              </div>
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-user text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">姓名</p>
                  <p class="text-lg font-bold text-gray-800">{{ user_info.user_name }}</p>
                </div>
              </div>
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-building-columns text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">所属院系</p>
                  <p id="profileDept" class="text-lg font-bold text-gray-800">加载中...</p>
                </div>
              </div>
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-mobile-screen text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">联系方式</p>
                  <p id="profileContact" class="text-lg font-bold text-gray-800">加载中...</p>
                </div>
              </div>
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-user-tag text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">角色</p>
                  <p class="text-lg font-bold text-gray-800">{{ user_info.role_name }}</p>
                </div>
              </div>
              <div class="group flex items-center p-4 rounded-xl hover:bg-primary/5 transition-all">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center mr-4 group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-book text-primary text-lg"></i>
                </div>
                <div>
                  <p class="text-sm text-gray-500">授课课程</p>
                  <p id="profileCourses" class="text-lg font-bold text-gray-800">加载中...</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 工作统计 -->
          <div class="glass-card rounded-3xl p-8 hover-lift">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
              <i class="fa-solid fa-chart-pie mr-3 text-accent text-2xl"></i>工作统计
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center p-4 bg-primary/5 rounded-xl">
                <p class="text-3xl font-bold text-primary" id="profileStatTotal">0</p>
                <p class="text-sm text-gray-500 mt-1">请假申请</p>
              </div>
              <div class="text-center p-4 bg-green-50 rounded-xl">
                <p class="text-3xl font-bold text-green-600" id="profileStatApproved">0</p>
                <p class="text-sm text-gray-500 mt-1">已批准</p>
              </div>
              <div class="text-center p-4 bg-amber-50 rounded-xl">
                <p class="text-3xl font-bold text-amber-600" id="profileStatPending">0</p>
                <p class="text-sm text-gray-500 mt-1">待审批</p>
              </div>
              <div class="text-center p-4 bg-blue-50 rounded-xl">
                <p class="text-3xl font-bold text-blue-600" id="profileStatNotify">0</p>
                <p class="text-sm text-gray-500 mt-1">发送通知</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 右侧：头像和快捷操作 -->
        <div class="space-y-6">
          <div class="glass-card rounded-3xl p-6 hover-lift text-center">
            <div class="relative inline-block mb-4 group cursor-pointer" onclick="document.getElementById('avatarInput').click()">
              <div class="absolute -inset-2 bg-gradient-to-r from-primary via-accent to-primary-light rounded-3xl blur-lg opacity-30"></div>
              <div id="profileAvatar" class="relative w-28 h-28 rounded-2xl bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white text-4xl font-bold shadow-xl overflow-hidden">
                {{ user_info.user_name[0] if user_info.user_name else 'T' }}
              </div>
              <div class="absolute inset-0 bg-black/40 rounded-2xl opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">
                <i class="fa-solid fa-camera text-white text-2xl"></i>
              </div>
            </div>
            <input type="file" id="avatarInput" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
            <p class="text-xs text-gray-400 mb-2">点击头像更换</p>
            <h4 class="font-bold text-xl text-gray-800">{{ user_info.user_name }}</h4>
            <p class="text-primary font-medium">{{ user_info.role_name }}</p>
            <div class="mt-4 pt-4 border-t border-gray-100">
              <p class="text-xs text-gray-400">工号：{{ user_info.user_account }}</p>
            </div>
          </div>
          
          <!-- 快捷操作 -->
          <div class="glass-card rounded-3xl p-6 hover-lift">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center">
              <i class="fa-solid fa-bolt mr-2 text-accent"></i>快捷操作
            </h4>
            <div class="space-y-3">
              <button onclick="switchTab('leaves')" class="w-full p-3 rounded-xl bg-primary/10 text-primary hover:bg-primary/20 transition-all text-left flex items-center">
                <i class="fa-solid fa-clipboard-list mr-3"></i>查看请假申请
              </button>
              <button onclick="switchTab('notification')" class="w-full p-3 rounded-xl bg-accent/10 text-accent hover:bg-accent/20 transition-all text-left flex items-center">
                <i class="fa-solid fa-bell mr-3"></i>发送通知
              </button>
              <button onclick="switchTab('chat')" class="w-full p-3 rounded-xl bg-green-100 text-green-600 hover:bg-green-200 transition-all text-left flex items-center">
                <i class="fa-solid fa-comments mr-3"></i>学生聊天
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    let allLeaveRecords = [];
    let teacherAvatar = null;  // 教师头像
    const teacherName = '{{ user_info.user_name }}';
    
    // Toast提示
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 transition-opacity ${type === 'success' ? 'bg-primary text-white' : 'bg-red-500 text-white'}`;
      toast.style.opacity = '1';
      toast.style.pointerEvents = 'auto';
      setTimeout(() => { toast.style.opacity = '0'; toast.style.pointerEvents = 'none'; }, 3000);
    }

    // 页面切换
    function switchTab(tabName) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${tabName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('text-primary', 'bg-white', 'shadow-md');
        t.classList.add('text-gray-600');
      });
      const activeTab = document.getElementById(`tab-${tabName}`);
      if (activeTab) {
        activeTab.classList.add('text-primary', 'bg-white', 'shadow-md');
        activeTab.classList.remove('text-gray-600');
      }
      
      const titles = {
        leaves: ['学生请假记录', '查看和管理您所授课程的学生请假申请'],
        chat: ['学生聊天', '与学生进行在线交流沟通'],
        notification: ['我的通知', '发送和查看您已发送的通知'],
        profile: ['个人信息', '查看和管理您的账户信息']
      };
      
      // 页面加载逻辑
      if (tabName === 'notification') loadNotifications();
      if (tabName === 'chat') loadChatStudents();
      if (tabName === 'profile') loadProfileInfo();
      
      document.getElementById('pageTitle').textContent = titles[tabName][0];
      document.getElementById('pageSubtitle').textContent = titles[tabName][1];
    }

    // 加载请假记录
    async function loadLeaveRecords() {
      const container = document.getElementById('leaveRecordsContainer');
      container.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-3"></i><p>加载中...</p></div>';
      
      try {
        const res = await fetch('/api/teacher/leave_requests');
        const data = await res.json();
        
        if (data.success && data.data) {
          allLeaveRecords = data.data;
          updateCourseFilter();
          renderLeaveRecords();
          updateStats();
        } else {
          container.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-inbox text-4xl mb-3"></i><p>暂无请假记录</p></div>';
        }
      } catch (err) {
        console.error('加载失败:', err);
        container.innerHTML = '<div class="p-8 text-center text-red-400"><i class="fa-solid fa-exclamation-circle text-4xl mb-3"></i><p>加载失败，请刷新重试</p></div>';
      }
    }
    
    // 更新课程筛选下拉框
    function updateCourseFilter() {
      const select = document.getElementById('courseFilter');
      const courses = [...new Set(allLeaveRecords.map(r => r.course_id).filter(c => c))];
      select.innerHTML = '<option value="">全部课程</option>' + courses.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // 时间筛选辅助函数
    function setToday() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filterDateStart').value = today;
      document.getElementById('filterDateEnd').value = today;
      applyFilters();
    }
    
    function setThisWeek() {
      const today = new Date();
      const dayOfWeek = today.getDay() || 7;
      const monday = new Date(today);
      monday.setDate(today.getDate() - dayOfWeek + 1);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      document.getElementById('filterDateStart').value = monday.toISOString().split('T')[0];
      document.getElementById('filterDateEnd').value = sunday.toISOString().split('T')[0];
      applyFilters();
    }
    
    function clearDateFilter() {
      document.getElementById('filterDateStart').value = '';
      document.getElementById('filterDateEnd').value = '';
      applyFilters();
    }
    
    // 判断请假时间是否与筛选时间段有交集
    function isLeaveInDateRange(record, startDate, endDate) {
      if (!startDate && !endDate) return true;
      const leaveStart = record.start_time ? new Date(record.start_time) : null;
      const leaveEnd = record.end_time ? new Date(record.end_time) : leaveStart;
      if (!leaveStart) return true;
      
      const filterStart = startDate ? new Date(startDate + 'T00:00:00') : null;
      const filterEnd = endDate ? new Date(endDate + 'T23:59:59') : null;
      
      // 请假时间与筛选时间有交集
      if (filterStart && filterEnd) {
        return leaveStart <= filterEnd && leaveEnd >= filterStart;
      } else if (filterStart) {
        return leaveEnd >= filterStart;
      } else if (filterEnd) {
        return leaveStart <= filterEnd;
      }
      return true;
    }
    
    // 获取筛选后的记录
    function getFilteredRecords() {
      const courseFilter = document.getElementById('courseFilter').value;
      const startDate = document.getElementById('filterDateStart').value;
      const endDate = document.getElementById('filterDateEnd').value;
      
      let filtered = allLeaveRecords;
      if (courseFilter) filtered = filtered.filter(r => r.course_id === courseFilter);
      filtered = filtered.filter(r => isLeaveInDateRange(r, startDate, endDate));
      return filtered;
    }
    
    // 应用筛选并更新统计
    function applyFilters() {
      renderLeaveRecords();
      renderCourseAttendance();
    }

    // 渲染请假记录
    function renderLeaveRecords() {
      const container = document.getElementById('leaveRecordsContainer');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let filtered = getFilteredRecords();
      if (searchTerm) filtered = filtered.filter(r => (r.student_name || '').toLowerCase().includes(searchTerm) || (r.student_id || '').includes(searchTerm));
      
      // 统计去重的学生数
      const uniqueStudents = [...new Set(filtered.map(r => r.student_id))];
      document.getElementById('statTotal').textContent = uniqueStudents.length;
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-inbox text-4xl mb-3"></i><p>暂无匹配的请假记录</p></div>';
        return;
      }
      
      container.innerHTML = filtered.map(r => {
        let statusClass = 'badge-pending', statusIcon = 'fa-clock';
        if (r.approval_status === '已批准') { statusClass = 'badge-approved'; statusIcon = 'fa-circle-check'; }
        else if (r.approval_status === '已驳回') { statusClass = 'badge-rejected'; statusIcon = 'fa-circle-xmark'; }
        
        const startDate = r.start_time ? new Date(r.start_time).toLocaleDateString('zh-CN') : '-';
        const endDate = r.end_time ? new Date(r.end_time).toLocaleDateString('zh-CN') : '-';
        
        return `
          <div class="p-5 hover:bg-primary/5 transition-all cursor-pointer" onclick="showLeaveDetail(${JSON.stringify(r).replace(/"/g, '&quot;')})">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary/20 to-accent/10 flex items-center justify-center text-primary font-bold">
                  ${(r.student_name || '?')[0]}
                </div>
                <div>
                  <p class="font-semibold text-gray-800">${r.student_name || '未知'}</p>
                  <p class="text-sm text-gray-500">${r.student_id || '-'}</p>
                </div>
              </div>
              <div class="text-right">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                  <i class="fa-solid ${statusIcon} mr-1"></i>${r.approval_status || '待审批'}
                </span>
                <p class="text-sm text-gray-400 mt-1">${startDate} 至 ${endDate}</p>
              </div>
            </div>
            <p class="mt-3 text-sm text-gray-600 line-clamp-1">${r.leave_reason || '无请假原因'}</p>
          </div>
        `;
      }).join('');
    }

    // 更新统计
    function updateStats() {
      document.getElementById('statTotal').textContent = allLeaveRecords.length;
      loadAttendanceData();
    }
    
    let courseStudentCounts = {};
    
    // 加载课程学生数据
    async function loadAttendanceData() {
      const container = document.getElementById('courseAttendanceStats');
      try {
        const res = await fetch('/api/teacher/course_students');
        const data = await res.json();
        if (data.success && data.data && Object.keys(data.data).length > 0) {
          courseStudentCounts = data.data;
        }
      } catch (err) {
        console.error('加载课程学生数失败:', err);
      }
      // 无论API成功与否，都渲染课程统计
      renderCourseAttendance();
    }
    
    // 渲染每门课的到课统计（使用时间筛选，学号去重）
    function renderCourseAttendance() {
      const container = document.getElementById('courseAttendanceStats');
      const courses = Object.keys(courseStudentCounts);
      const startDate = document.getElementById('filterDateStart').value;
      const endDate = document.getElementById('filterDateEnd').value;
      
      // 获取时间筛选后的请假记录
      const filteredLeaves = allLeaveRecords.filter(r => isLeaveInDateRange(r, startDate, endDate));
      
      // 如果没有选课数据，从请假记录中提取课程并显示请假人数（去重）
      if (courses.length === 0) {
        const leaveCourses = [...new Set(allLeaveRecords.map(r => r.course_id).filter(c => c))];
        if (leaveCourses.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-400 py-2">暂无课程数据</div>';
          return;
        }
        container.innerHTML = leaveCourses.map(courseId => {
          // 该课程在时间段内请假的学生（去重）
          const courseLeaves = filteredLeaves.filter(r => r.course_id === courseId);
          const uniqueLeaveStudents = [...new Set(courseLeaves.map(r => r.student_id))];
          const leaveCount = uniqueLeaveStudents.length;
          return `
            <div class="flex items-center space-x-2 px-4 py-2.5 bg-amber-50 text-amber-600 border-amber-200 rounded-xl border cursor-pointer hover:shadow-md transition-all" onclick="document.getElementById('courseFilter').value='${courseId}';applyFilters()">
              <i class="fa-solid fa-book text-amber-500"></i>
              <span class="font-medium">${courseId}</span>
              <span class="text-gray-400">|</span>
              <i class="fa-solid fa-user-clock text-amber-500 text-sm"></i>
              <span class="font-bold">${leaveCount}</span>
              <span class="text-xs">人请假</span>
            </div>
          `;
        }).join('');
        return;
      }
      
      container.innerHTML = courses.map(courseId => {
        const total = courseStudentCounts[courseId] || 0;
        // 该课程在时间段内请假的学生（去重）
        const courseLeaves = filteredLeaves.filter(r => r.course_id === courseId);
        const uniqueLeaveStudents = [...new Set(courseLeaves.map(r => r.student_id))];
        const leaveCount = uniqueLeaveStudents.length;
        const attendCount = Math.max(0, total - leaveCount);
        const attendRate = total > 0 ? Math.round((attendCount / total) * 100) : 100;
        
        // 根据出勤率决定颜色
        let colorClass = 'bg-green-50 text-green-600 border-green-200';
        let iconColor = 'text-green-500';
        if (attendRate < 90) { colorClass = 'bg-amber-50 text-amber-600 border-amber-200'; iconColor = 'text-amber-500'; }
        if (attendRate < 80) { colorClass = 'bg-red-50 text-red-600 border-red-200'; iconColor = 'text-red-500'; }
        
        return `
          <div class="flex items-center space-x-2 px-4 py-2.5 ${colorClass} rounded-xl border cursor-pointer hover:shadow-md transition-all" onclick="document.getElementById('courseFilter').value='${courseId}';applyFilters()">
            <i class="fa-solid fa-book ${iconColor}"></i>
            <span class="font-medium">${courseId}</span>
            <span class="text-gray-400">|</span>
            <i class="fa-solid fa-users ${iconColor} text-sm"></i>
            <span class="font-bold">${attendCount}</span>
            <span class="text-gray-400">/</span>
            <span class="font-bold">${total}</span>
            <span class="text-xs px-1.5 py-0.5 rounded ${attendRate >= 90 ? 'bg-green-100' : attendRate >= 80 ? 'bg-amber-100' : 'bg-red-100'}">${attendRate}%</span>
          </div>
        `;
      }).join('');
    }

    // 格式化日期
    function formatDate(d) {
      return d ? new Date(d).toLocaleString('zh-CN') : '-';
    }

    // 显示请假详情
    function showLeaveDetail(request) {
      const formatDate = d => d ? new Date(d).toLocaleString('zh-CN') : '-';
      let statusBg = 'from-amber-500 to-orange-500', statusIcon = 'fa-solid fa-clock';
      if (request.approval_status === '已批准') { statusBg = 'from-emerald-500 to-green-500'; statusIcon = 'fa-solid fa-circle-check'; }
      else if (request.approval_status === '已驳回') { statusBg = 'from-red-500 to-pink-500'; statusIcon = 'fa-solid fa-circle-xmark'; }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeIn';
      modal.innerHTML = `
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full mx-4 animate-scaleIn overflow-hidden">
          <div class="relative p-6 bg-gradient-to-r ${statusBg}">
            <button class="close-btn absolute top-4 right-4 w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30"><i class="fa-solid fa-xmark"></i></button>
            <div class="flex items-center space-x-4">
              <div class="w-16 h-16 rounded-2xl bg-white/20 flex items-center justify-center text-white text-2xl font-bold">${(request.student_name || '?')[0]}</div>
              <div class="text-white">
                <h3 class="text-xl font-bold">${request.student_name || '未知'}</h3>
                <p class="text-white/80 text-sm">${request.student_id || '-'}</p>
              </div>
            </div>
            <span class="absolute bottom-4 right-6 px-4 py-1.5 bg-white/20 text-white text-sm font-medium rounded-full flex items-center"><i class="${statusIcon} mr-1.5"></i>${request.approval_status || '待审批'}</span>
          </div>
          <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
            <!-- 基本信息 -->
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-tag mr-1"></i>请假类型</p>
                <p class="font-semibold text-gray-800">${request.sort || '其他'}</p>
              </div>
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-book mr-1"></i>课程编号</p>
                <p class="font-semibold text-gray-800">${request.course_id || '-'}</p>
              </div>
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-building mr-1"></i>院系</p>
                <p class="font-semibold text-gray-800">${request.dept || '-'}</p>
              </div>
              <div class="bg-gray-50 rounded-xl p-4">
                <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-history mr-1"></i>请假次数</p>
                <p class="font-semibold text-gray-800">${request.times !== undefined ? request.times : '-'} 次</p>
              </div>
            </div>
            
            <!-- 请假时间 -->
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-calendar-days mr-1"></i>请假时间</p>
              <p class="font-semibold text-gray-800">${formatDate(request.start_time)} 至 ${formatDate(request.end_time)}</p>
            </div>
            
            <!-- 请假原因 -->
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-xs text-gray-400 mb-1"><i class="fa-solid fa-comment mr-1"></i>请假原因</p>
              <p class="text-gray-800">${request.leave_reason || '无'}</p>
            </div>
            
            <!-- 审批信息 -->
            ${request.approver_name || request.approval_time ? `
            <div class="bg-blue-50 rounded-xl p-4">
              <p class="text-xs text-blue-400 mb-1"><i class="fa-solid fa-user-check mr-1"></i>审批信息</p>
              <div class="text-gray-800">
                ${request.approver_name ? `<p class="text-sm">审批人：<span class="font-medium">${request.approver_name}</span></p>` : ''}
                ${request.approval_time ? `<p class="text-sm">审批时间：<span class="font-medium">${formatDate(request.approval_time)}</span></p>` : ''}
              </div>
            </div>
            ` : ''}
            
            <!-- 佐证材料 -->
            ${request.attachment ? `
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-xs text-gray-400 mb-2"><i class="fa-solid fa-paperclip mr-1"></i>佐证材料</p>
              ${request.attachment.toLowerCase().endsWith('.pdf') ? `
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                    <i class="fa-solid fa-file-pdf text-red-500"></i>
                  </div>
                  <span class="text-gray-700 text-sm">${request.attachment}</span>
                </div>
                <a href="/zhengming/${request.attachment}" target="_blank" class="px-3 py-1.5 bg-primary text-white rounded-lg text-sm hover:bg-primary/80">
                  <i class="fa-solid fa-eye mr-1"></i>预览
                </a>
              </div>
              ` : `
              <img src="/zhengming/${request.attachment}" class="max-w-full max-h-48 rounded-lg cursor-pointer hover:opacity-90" 
                   onclick="window.open('/zhengming/${request.attachment}', '_blank')" 
                   onerror="this.outerHTML='<span class=text-gray-400>文件加载失败</span>'" />
              `}
            </div>
            ` : ''}
          </div>
          <div class="px-6 pb-6">
            <button class="close-btn w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition-all">关闭</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
      modal.addEventListener('click', e => { if (e.target === modal) document.body.removeChild(modal); });
    }

    let allNotifications = [];
    
    // 加载已发送的通知
    async function loadNotifications() {
      const container = document.getElementById('notificationList');
      container.innerHTML = '<div class="p-4 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin text-xl mb-2"></i><p>加载中...</p></div>';
      
      try {
        const res = await fetch('/api/teacher/notifications');
        const data = await res.json();
        
        if (data.success && data.data) {
          allNotifications = data.data;
          updateNotifyStats();
          renderNotifications();
        } else {
          container.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-bell-slash text-4xl mb-3"></i><p>暂无已发送的通知</p></div>';
        }
      } catch (err) {
        console.error('加载通知失败:', err);
        container.innerHTML = '<div class="p-8 text-center text-red-400"><i class="fa-solid fa-exclamation-circle text-4xl mb-3"></i><p>加载失败</p></div>';
      }
    }
    
    // 更新通知统计
    function updateNotifyStats() {
      document.getElementById('notifyStat1').textContent = allNotifications.length;
      document.getElementById('notifyStat2').textContent = allNotifications.filter(n => n.notify_type === '课程通知').length;
      document.getElementById('notifyStat3').textContent = allNotifications.filter(n => n.notify_type === '作业通知').length;
      document.getElementById('notifyStat4').textContent = allNotifications.filter(n => n.priority === '紧急').length;
    }
    
    // 渲染通知列表
    function renderNotifications() {
      const container = document.getElementById('notificationList');
      const filter = document.getElementById('notifyFilter').value;
      let filtered = allNotifications;
      if (filter) filtered = filtered.filter(n => n.notify_type === filter);
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-400"><i class="fa-solid fa-bell-slash text-4xl mb-3"></i><p>暂无通知</p></div>';
        return;
      }
      
      container.innerHTML = filtered.map(n => {
        let typeColor = 'bg-gray-100 text-gray-600';
        let typeIcon = 'fa-bell';
        if (n.notify_type === '课程通知') { typeColor = 'bg-blue-100 text-blue-600'; typeIcon = 'fa-book'; }
        else if (n.notify_type === '作业通知') { typeColor = 'bg-green-100 text-green-600'; typeIcon = 'fa-file-pen'; }
        else if (n.notify_type === '考试通知') { typeColor = 'bg-purple-100 text-purple-600'; typeIcon = 'fa-pen-to-square'; }
        else if (n.notify_type === '调课通知') { typeColor = 'bg-orange-100 text-orange-600'; typeIcon = 'fa-calendar-alt'; }
        
        let priorityBadge = '';
        if (n.priority === '紧急') priorityBadge = '<span class="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full ml-2">紧急</span>';
        else if (n.priority === '重要') priorityBadge = '<span class="px-2 py-0.5 bg-orange-500 text-white text-xs rounded-full ml-2">重要</span>';
        
        return `
          <div class="p-4 bg-white/50 rounded-xl hover:bg-white transition-all cursor-pointer group" onclick="showNotifyDetail(${JSON.stringify(n).replace(/"/g, '&quot;')})">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center">
                <span class="w-7 h-7 rounded-lg ${typeColor} flex items-center justify-center mr-2">
                  <i class="fa-solid ${typeIcon} text-xs"></i>
                </span>
                <h4 class="font-semibold text-gray-800">${n.title}</h4>
                ${priorityBadge}
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-xs text-gray-400">${n.create_time}</span>
                <button onclick="event.stopPropagation();deleteNotify(${n.id})" class="w-6 h-6 rounded-full text-gray-300 hover:text-red-500 hover:bg-red-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                  <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
              </div>
            </div>
            <p class="text-sm text-gray-600 line-clamp-2 ml-9">${n.content}</p>
            ${n.course_id ? `<p class="text-xs text-gray-400 mt-2 ml-9"><i class="fa-solid fa-book mr-1"></i>课程：${n.course_id}</p>` : ''}
          </div>
        `;
      }).join('');
    }
    
    // 显示通知详情
    function showNotifyDetail(n) {
      let typeColor = 'from-gray-500 to-gray-600';
      if (n.notify_type === '课程通知') typeColor = 'from-blue-500 to-blue-600';
      else if (n.notify_type === '作业通知') typeColor = 'from-green-500 to-green-600';
      else if (n.notify_type === '考试通知') typeColor = 'from-purple-500 to-purple-600';
      else if (n.notify_type === '调课通知') typeColor = 'from-orange-500 to-orange-600';
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeIn';
      modal.innerHTML = `
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full mx-4 animate-scaleIn overflow-hidden">
          <div class="relative p-6 bg-gradient-to-r ${typeColor}">
            <button class="close-btn absolute top-4 right-4 w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30"><i class="fa-solid fa-xmark"></i></button>
            <div class="text-white">
              <div class="flex items-center mb-2">
                <span class="px-3 py-1 bg-white/20 rounded-full text-sm mr-2">${n.notify_type || '通知'}</span>
                ${n.priority === '紧急' ? '<span class="px-3 py-1 bg-red-500 rounded-full text-sm">紧急</span>' : n.priority === '重要' ? '<span class="px-3 py-1 bg-orange-500 rounded-full text-sm">重要</span>' : ''}
              </div>
              <h3 class="text-xl font-bold">${n.title}</h3>
            </div>
          </div>
          <div class="p-6 space-y-4">
            <div class="flex items-center text-sm text-gray-500">
              <i class="fa-solid fa-clock mr-2"></i>发送时间：${n.create_time}
            </div>
            ${n.course_id ? `<div class="flex items-center text-sm text-gray-500"><i class="fa-solid fa-book mr-2"></i>关联课程：${n.course_id}</div>` : ''}
            <div class="bg-gray-50 rounded-xl p-4">
              <p class="text-gray-800 whitespace-pre-wrap">${n.content}</p>
            </div>
          </div>
          <div class="px-6 pb-6 flex space-x-3">
            <button onclick="deleteNotify(${n.id});this.closest('.fixed').remove();" class="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-medium hover:bg-red-100 transition-all">
              <i class="fa-solid fa-trash-can mr-2"></i>删除
            </button>
            <button class="close-btn flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200 transition-all">关闭</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
      modal.addEventListener('click', e => { if (e.target === modal) document.body.removeChild(modal); });
    }
    
    // 删除通知
    async function deleteNotify(id) {
      if (!confirm('确定要删除这条通知吗？')) return;
      try {
        const res = await fetch('/api/teacher/delete_notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (data.success) {
          showToast('删除成功');
          loadNotifications();
        } else {
          showToast(data.message || '删除失败', 'error');
        }
      } catch (err) {
        showToast('删除失败', 'error');
      }
    }
    
    // 发送通知
    async function sendNotification(e) {
      e.preventDefault();
      const title = document.getElementById('notifyTitle').value.trim();
      const content = document.getElementById('notifyContent').value.trim();
      const notify_type = document.getElementById('notifyType').value;
      const priority = document.getElementById('notifyPriority').value;
      const course_id = document.getElementById('notifyCourse').value.trim();
      
      if (!title || !content) {
        showToast('请填写完整信息', 'error');
        return;
      }
      
      try {
        const res = await fetch('/api/teacher/send_notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, content, notify_type, priority, course_id })
        });
        const data = await res.json();
        if (data.success) {
          showToast('通知发送成功！');
          document.getElementById('notificationForm').reset();
          loadNotifications();
        } else {
          showToast(data.message || '发送失败', 'error');
        }
      } catch (err) {
        showToast('发送异常，请重试', 'error');
      }
    }

    // ========== 聊天功能 ==========
    let allStudents = [];
    let currentChatStudent = null;
    let chatMessages = [];
    
    // 加载学生列表
    async function loadChatStudents() {
      const container = document.getElementById('studentList');
      container.innerHTML = '<div class="p-4 text-center text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> 加载中...</div>';
      
      try {
        const res = await fetch('/api/teacher/chat/students');
        const data = await res.json();
        if (data.success && data.data) {
          allStudents = data.data;
          renderStudentList();
        } else {
          container.innerHTML = '<div class="p-4 text-center text-gray-400">暂无学生</div>';
        }
      } catch (err) {
        console.error('加载学生列表失败:', err);
        container.innerHTML = '<div class="p-4 text-center text-red-400">加载失败</div>';
      }
    }
    
    // 渲染学生列表
    function renderStudentList() {
      const container = document.getElementById('studentList');
      const search = document.getElementById('studentSearch').value.toLowerCase();
      let filtered = allStudents;
      if (search) filtered = filtered.filter(s => s.name && (s.name.toLowerCase().includes(search) || s.id.includes(search)));
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-400">无匹配学生</div>';
        return;
      }
      
      container.innerHTML = filtered.map(s => {
        const initial = (s.name || '?').charAt(0);
        return `
          <div class="student-item px-3 py-2 cursor-pointer hover:bg-primary/5 border-b border-gray-100 flex items-center space-x-2 ${currentChatStudent && currentChatStudent.id === s.id ? 'bg-primary/10' : ''}"
               onclick="selectStudent('${s.id}', '${s.name || ''}')">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center text-primary font-bold text-sm flex-shrink-0">${initial}</div>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-gray-800 text-sm truncate">${s.name || '未知'}</p>
              <p class="text-xs text-gray-400 truncate">${s.id}</p>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterStudents() { renderStudentList(); }
    
    // 选择学生
    function selectStudent(id, name) {
      currentChatStudent = { id, name };
      document.getElementById('chatStudentName').textContent = name;
      document.getElementById('chatStudentId').textContent = id;
      document.getElementById('chatAvatar').textContent = name.charAt(0);
      document.getElementById('chatInput').disabled = false;
      document.getElementById('chatInput').placeholder = `给${name}发送消息...`;
      document.getElementById('chatSendBtn').disabled = false;
      renderStudentList();
      loadChatMessages();
    }
    
    // 加载聊天记录
    async function loadChatMessages() {
      if (!currentChatStudent) return;
      const container = document.getElementById('chatMessages');
      
      try {
        const res = await fetch(`/api/teacher/chat/messages?student_id=${currentChatStudent.id}`);
        const data = await res.json();
        if (data.success) {
          chatMessages = data.data || [];
          renderChatMessages();
        }
      } catch (err) {
        console.error('加载聊天记录失败:', err);
      }
    }
    
    // 渲染聊天消息
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      if (chatMessages.length === 0) {
        container.innerHTML = `
          <div class="text-center py-10 text-gray-400">
            <i class="fa-solid fa-comments text-3xl mb-2"></i>
            <p>开始与${currentChatStudent ? currentChatStudent.name : ''}的对话</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = chatMessages.map(msg => {
        const isSent = msg.sender_role === '讲师';
        const studentAvatar = currentChatStudent && currentChatStudent.avatar 
          ? `<img src="/head_image/${currentChatStudent.avatar}" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
             <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 items-center justify-center text-white text-sm font-bold flex-shrink-0" style="display:none">${currentChatStudent.name.charAt(0)}</div>`
          : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">${currentChatStudent ? currentChatStudent.name.charAt(0) : 'S'}</div>`;
        
        return `
          <div class="flex ${isSent ? 'justify-end' : 'justify-start'} mb-6 items-end gap-3">
            ${!isSent ? studentAvatar : ''}
            <div class="flex flex-col ${isSent ? 'items-end' : 'items-start'} max-w-[70%]">
              <div class="px-4 py-3 rounded-2xl ${isSent ? 'bg-gradient-to-r from-primary to-accent text-white rounded-br-md' : 'bg-white shadow-sm border text-gray-800 rounded-bl-md'}">
                <p class="text-sm leading-relaxed">${msg.content}</p>
              </div>
              <p class="text-xs mt-1 px-2 text-gray-400">${msg.create_time || ''}</p>
            </div>
            ${isSent ? (teacherAvatar 
              ? `<img src="/head_image/${teacherAvatar}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">`
              : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white text-sm font-bold flex-shrink-0">${teacherName.charAt(0)}</div>`) : ''}
          </div>
        `;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    // 发送消息
    async function sendChatMessage() {
      if (!currentChatStudent) {
        showToast('请先选择学生', 'error');
        return;
      }
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.value = '';
      chatMessages.push({ content: message, sender_role: '讲师', create_time: new Date().toLocaleString('zh-CN') });
      renderChatMessages();
      
      try {
        const res = await fetch('/api/teacher/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: currentChatStudent.id, message })
        });
        const data = await res.json();
        if (!data.success) showToast(data.message || '发送失败', 'error');
      } catch (err) {
        showToast('发送失败', 'error');
      }
    }
    
    // ========== 个人信息功能 ==========
    async function loadProfileInfo() {
      try {
        const res = await fetch('/api/teacher/profile');
        const data = await res.json();
        console.log('Profile API response:', data);
        if (data.success && data.data) {
          const info = data.data;
          document.getElementById('profileDept').textContent = info.dept || '未设置';
          document.getElementById('profileContact').textContent = info.contact || '未设置';
          document.getElementById('profileCourses').textContent = info.courses || '未设置';
          // 显示头像
          if (info.avatar) {
            teacherAvatar = info.avatar;  // 保存教师头像用于聊天
            const avatarImg = `<img src="/head_image/${info.avatar}" class="w-full h-full object-cover">`;
            document.getElementById('profileAvatar').innerHTML = avatarImg;
            document.getElementById('navAvatar').innerHTML = avatarImg;
          }
        } else {
          // API返回失败时显示错误信息
          document.getElementById('profileDept').textContent = '加载失败';
          document.getElementById('profileContact').textContent = '加载失败';
          document.getElementById('profileCourses').textContent = '加载失败';
          console.error('API返回失败:', data.message);
        }
      } catch (err) {
        console.error('加载个人信息失败:', err);
        document.getElementById('profileDept').textContent = '加载失败';
        document.getElementById('profileContact').textContent = '加载失败';
        document.getElementById('profileCourses').textContent = '加载失败';
      }
      
      // 更新统计
      document.getElementById('profileStatTotal').textContent = allLeaveRecords.length;
      document.getElementById('profileStatApproved').textContent = allLeaveRecords.filter(r => r.approval_status === '已批准').length;
      document.getElementById('profileStatPending').textContent = allLeaveRecords.filter(r => r.approval_status === '待审批').length;
      document.getElementById('profileStatNotify').textContent = allNotifications.length;
    }
    
    // 编辑联系方式
    function showEditContact() {
      const currentContact = document.getElementById('profileContact').textContent;
      const newContact = prompt('请输入新的联系方式：', currentContact === '未设置' ? '' : currentContact);
      if (newContact !== null) {
        updateContact(newContact);
      }
    }
    
    async function updateContact(contact) {
      try {
        const res = await fetch('/api/teacher/update_contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contact })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById('profileContact').textContent = contact || '未设置';
          showToast('联系方式更新成功');
        } else {
          showToast(data.message || '更新失败', 'error');
        }
      } catch (err) {
        showToast('更新失败', 'error');
      }
    }
    
    // 上传头像
    async function uploadAvatar(input) {
      if (!input.files || !input.files[0]) return;
      
      const file = input.files[0];
      if (file.size > 2 * 1024 * 1024) {
        showToast('图片大小不能超过2MB', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('avatar', file);
      
      try {
        showToast('上传中...');
        const res = await fetch('/api/user/avatar/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.success) {
          // 更新头像显示（个人信息页和导航栏）
          const avatarImg = `<img src="/head_image/${data.avatar}?t=${Date.now()}" class="w-full h-full object-cover">`;
          document.getElementById('profileAvatar').innerHTML = avatarImg;
          document.getElementById('navAvatar').innerHTML = avatarImg;
          teacherAvatar = data.avatar;
          showToast('头像更新成功');
        } else {
          showToast(data.message || '上传失败', 'error');
        }
      } catch (err) {
        console.error('上传头像失败:', err);
        showToast('上传失败', 'error');
      }
      input.value = '';
    }

    // 退出登录
    function handleLogout() {
      if (confirm('确定要退出登录吗？')) {
        fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/login').catch(() => window.location.href = '/login');
      }
    }

    // ========== AI助手功能 ==========
    let aiChatOpen = false;
    
    function toggleAiChat() {
      const chatBox = document.getElementById('aiChatBox');
      if (!chatBox) return;
      aiChatOpen = !aiChatOpen;
      if (aiChatOpen) {
        chatBox.classList.remove('hidden');
        setTimeout(() => {
          chatBox.classList.remove('scale-95', 'opacity-0');
          chatBox.classList.add('scale-100', 'opacity-100');
        }, 10);
        document.getElementById('aiChatInput')?.focus();
      } else {
        chatBox.classList.remove('scale-100', 'opacity-100');
        chatBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => chatBox.classList.add('hidden'), 300);
      }
    }

    function addAiMessage(content, isUser = false) {
      const container = document.getElementById('aiChatMessages');
      if (!container) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
      if (isUser) {
        msgDiv.innerHTML = `
          <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-user text-white text-sm"></i>
          </div>
          <div class="bg-primary text-white rounded-2xl rounded-tr-none px-4 py-2 max-w-[80%]">
            <p class="text-sm">${content}</p>
          </div>`;
      } else {
        msgDiv.innerHTML = `
          <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
            <i class="fa-solid fa-dragon text-primary text-sm"></i>
          </div>
          <div class="bg-gray-100 rounded-2xl rounded-tl-none px-4 py-2 max-w-[80%]">
            <p class="text-sm text-gray-700">${content}</p>
          </div>`;
      }
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    async function sendAiMessage() {
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiSendBtn');
      const message = input?.value?.trim();
      if (!message) return;
      addAiMessage(message, true);
      input.value = '';
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      addAiMessage('<i class="fa-solid fa-ellipsis fa-beat"></i> 思考中...');
      try {
        const response = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const data = await response.json();
        const container = document.getElementById('aiChatMessages');
        container.removeChild(container.lastChild);
        if (data.success) {
          addAiMessage(data.reply);
        } else {
          addAiMessage('😅 ' + (data.message || '抱歉，出了点问题'));
        }
      } catch (error) {
        const container = document.getElementById('aiChatMessages');
        container.removeChild(container.lastChild);
        addAiMessage('😅 网络错误，请稍后再试');
      }
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
    }

    // 吉祥物点击事件
    document.getElementById('mascot')?.addEventListener('click', toggleAiChat);

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadLeaveRecords();
      loadProfileInfo();  // 加载头像
      document.getElementById('notificationForm').addEventListener('submit', sendNotification);
    });
  </script>
</body>
</html>

