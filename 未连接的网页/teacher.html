<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>任课老师工作平台 - 请假管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { 
            primary: '#4F46E5',
            secondary: '#EEF2FF',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
      }
      .card-hover {
        @apply hover:shadow-xl transition-all duration-300;
      }
      .btn-hover {
        @apply hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 active:translate-y-0;
      }
      .nav-active {
        @apply bg-primary text-white;
      }
      .nav-inactive {
        @apply hover:bg-gray-100 transition-colors;
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 min-h-screen text-gray-800">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
          <i class="fa fa-graduation-cap text-primary text-xl"></i>
        </div>
        <h1 class="text-xl font-semibold">任课老师工作平台</h1>
      </div>
      <div class="text-sm flex items-center space-x-4">
        <span class="text-gray-600">欢迎，<span class="font-medium" id="teacherName">{{ user_info.user_name }}</span></span>
        <button id="logoutBtn" class="text-primary hover:text-primary/80 transition-colors flex items-center">
          <i class="fa fa-sign-out mr-1"></i>退出
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- 页面标题 -->
    <div class="text-center mb-8">
      <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-bold">请假审批管理</h2>
      <p class="text-gray-500 mt-2">学生请假申请的查看与审批管理</p>
    </div>

    <!-- 快捷统计卡片 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <!-- 待审批假条 -->
      <div class="bg-white rounded-xl p-5 card-shadow card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">待审批假条</p>
            <h3 class="text-2xl font-bold mt-1" id="pendingCount">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-warning/10 flex items-center justify-center">
            <i class="fa fa-calendar-times-o text-warning text-xl"></i>
          </div>
        </div>
        <div class="mt-4 text-xs text-warning">
          <a href="#" class="hover:underline flex items-center btn-hover" onclick="filterLeaveRequests('待审批')">
            立即处理 <i class="fa fa-angle-right ml-1"></i>
          </a>
        </div>
      </div>

      <!-- 已批准假条 -->
      <div class="bg-white rounded-xl p-5 card-shadow card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">已批准假条</p>
            <h3 class="text-2xl font-bold mt-1" id="approvedCount">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center">
            <i class="fa fa-check-circle text-success text-xl"></i>
          </div>
        </div>
        <div class="mt-4 text-xs text-success">
          <a href="#" class="hover:underline flex items-center btn-hover" onclick="filterLeaveRequests('已批准')">
            查看记录 <i class="fa fa-angle-right ml-1"></i>
          </a>
        </div>
      </div>

      <!-- 已驳回假条 -->
      <div class="bg-white rounded-xl p-5 card-shadow card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">已驳回假条</p>
            <h3 class="text-2xl font-bold mt-1" id="rejectedCount">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-danger/10 flex items-center justify-center">
            <i class="fa fa-times-circle text-danger text-xl"></i>
          </div>
        </div>
        <div class="mt-4 text-xs text-danger">
          <a href="#" class="hover:underline flex items-center btn-hover" onclick="filterLeaveRequests('已驳回')">
            查看详情 <i class="fa fa-angle-right ml-1"></i>
          </a>
        </div>
      </div>

      <!-- 本月请假总数 -->
      <div class="bg-white rounded-xl p-5 card-shadow card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">本月请假总数</p>
            <h3 class="text-2xl font-bold mt-1" id="totalCount">0</h3>
          </div>
          <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
            <i class="fa fa-calendar text-primary text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- 假条筛选 -->
    <div class="bg-white rounded-xl p-6 card-shadow mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex flex-wrap gap-3">
          <button id="filterAll" class="px-4 py-2 bg-primary text-white rounded-lg btn-hover">全部假条</button>
          <button id="filterPending" class="px-4 py-2 bg-warning/10 text-warning rounded-lg hover:bg-warning/20 transition-colors btn-hover">待审批</button>
          <button id="filterApproved" class="px-4 py-2 bg-success/10 text-success rounded-lg hover:bg-success/20 transition-colors btn-hover">已批准</button>
          <button id="filterRejected" class="px-4 py-2 bg-danger/10 text-danger rounded-lg hover:bg-danger/20 transition-colors btn-hover">已驳回</button>
        </div>
        <div class="flex items-center gap-3 w-full md:w-auto">
          <div class="relative flex-grow md:flex-grow-0">
            <input id="searchInput" type="text" placeholder="搜索学生姓名/学号"
              class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none w-full md:w-64">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
          <select id="courseSelect"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none">
            <option value="">所有课程</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 全部假条列表 -->
    <div class="bg-white rounded-xl p-6 card-shadow mb-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold">全部假条</h3>
        <span id="recordCount" class="text-sm bg-primary/10 text-primary px-3 py-1 rounded-full">0条记录</span>
      </div>

      <div id="leaveListContainer" class="space-y-4">
        <!-- 假条列表将通过JavaScript动态生成 -->
        <div class="text-center py-8 text-gray-500">
          <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
          <p>正在加载数据...</p>
        </div>
      </div>

      <!-- 分页 -->
      <div class="mt-6 flex justify-center" id="paginationContainer">
        <div class="flex items-center space-x-2">
          <button id="prevPage" class="px-3 py-1 border border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50" disabled>
            上一页
          </button>
          <button class="px-3 py-1 border border-primary bg-primary text-white rounded-lg">1</button>
          <button id="nextPage" class="px-3 py-1 border border-gray-300 rounded-lg text-gray-500 hover:bg-gray-50" disabled>
            下一页
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-100 mt-12">
    <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-500">
      <p>© 2025 请了吗  任课老师工作平台 </p>
    </div>
  </footer>

  <script>
    // 全局变量
    let allLeaveRequests = [];
    let currentFilter = 'all';
    let currentPage = 1;
    const pageSize = 10;

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化事件监听
      initEventListeners();
      
      // 加载请假数据
      loadLeaveRequests();
      
      // 检查登录状态
      checkLoginStatus();
    });

    // 初始化事件监听
    function initEventListeners() {
      // 筛选按钮事件
      document.getElementById('filterAll').addEventListener('click', () => filterLeaveRequests('all'));
      document.getElementById('filterPending').addEventListener('click', () => filterLeaveRequests('待审批'));
      document.getElementById('filterApproved').addEventListener('click', () => filterLeaveRequests('已批准'));
      document.getElementById('filterRejected').addEventListener('click', () => filterLeaveRequests('已驳回'));
      
      // 搜索输入事件
      document.getElementById('searchInput').addEventListener('input', debounce(searchLeaveRequests, 300));
      
      // 课程筛选事件
      document.getElementById('courseSelect').addEventListener('change', filterByCourse);
      
      // 分页按钮事件
      document.getElementById('prevPage').addEventListener('click', goToPrevPage);
      document.getElementById('nextPage').addEventListener('click', goToNextPage);
      
      // 退出按钮事件
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    // 检查登录状态
    async function checkLoginStatus() {
      try {
        const response = await fetch('/api/check_login');
        const result = await response.json();
        
        if (!result.logged_in) {
          // 未登录，跳转到登录页
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('检查登录状态失败:', error);
        window.location.href = '/login';
      }
    }

    // 退出登录
    async function logout() {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST'
        });
        const result = await response.json();
        
        if (result.status === 'success') {
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('退出登录失败:', error);
      }
    }

    // 加载请假数据
    async function loadLeaveRequests() {
      try {
        const response = await fetch('/api/teacher/leave_requests');
        const result = await response.json();
        
        if (result.success) {
          allLeaveRequests = result.data;
          updateStatistics();
          updateCourseSelect();
          renderLeaveRequests();
        } else {
          showErrorMessage('加载数据失败: ' + result.message);
        }
      } catch (error) {
        console.error('加载请假数据失败:', error);
        showErrorMessage('网络错误，请稍后重试');
      }
    }

    // 更新统计数据
    function updateStatistics() {
      const pending = allLeaveRequests.filter(req => req.approval_status === '待审批').length;
      const approved = allLeaveRequests.filter(req => req.approval_status === '已批准').length;
      const rejected = allLeaveRequests.filter(req => req.approval_status === '已驳回').length;
      const total = allLeaveRequests.length;
      
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('approvedCount').textContent = approved;
      document.getElementById('rejectedCount').textContent = rejected;
      document.getElementById('totalCount').textContent = total;
    }

    // 更新课程选择下拉框
    function updateCourseSelect() {
      const courseSelect = document.getElementById('courseSelect');
      const courses = new Set();
      
      allLeaveRequests.forEach(req => {
        if (req.course_name) {
          courses.add(req.course_name);
        }
      });
      
      // 清空现有选项（保留第一个"所有课程"选项）
      while (courseSelect.options.length > 1) {
        courseSelect.remove(1);
      }
      
      // 添加课程选项
      courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        courseSelect.appendChild(option);
      });
    }

    // 筛选请假记录
    function filterLeaveRequests(filterType) {
      currentFilter = filterType;
      currentPage = 1;
      
      // 更新筛选按钮样式
      document.querySelectorAll('#filterAll, #filterPending, #filterApproved, #filterRejected').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700');
      });
      
      const activeBtn = filterType === 'all' ? '#filterAll' : 
                       filterType === '待审批' ? '#filterPending' :
                       filterType === '已批准' ? '#filterApproved' : '#filterRejected';
      
      document.querySelector(activeBtn).classList.remove('bg-gray-100', 'text-gray-700');
      document.querySelector(activeBtn).classList.add('bg-primary', 'text-white');
      
      // 重置搜索和课程筛选
      document.getElementById('searchInput').value = '';
      document.getElementById('courseSelect').value = '';
      
      renderLeaveRequests();
    }

    // 搜索请假记录
    function searchLeaveRequests() {
      renderLeaveRequests();
    }

    // 按课程筛选
    function filterByCourse() {
      renderLeaveRequests();
    }

    // 渲染请假记录
    function renderLeaveRequests() {
      const container = document.getElementById('leaveListContainer');
      let filteredRequests = [...allLeaveRequests];
      
      // 应用筛选条件
      if (currentFilter !== 'all') {
        filteredRequests = filteredRequests.filter(req => req.approval_status === currentFilter);
      }
      
      // 应用搜索条件
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      if (searchTerm) {
        filteredRequests = filteredRequests.filter(req => 
          (req.student_name && req.student_name.toLowerCase().includes(searchTerm)) ||
          (req.student_id && req.student_id.toLowerCase().includes(searchTerm))
        );
      }
      
      // 应用课程筛选
      const selectedCourse = document.getElementById('courseSelect').value;
      if (selectedCourse) {
        filteredRequests = filteredRequests.filter(req => 
          req.course_name === selectedCourse
        );
      }
      
      // 按提交时间降序排序
      filteredRequests.sort((a, b) => {
        const dateA = a.submit_time ? new Date(a.submit_time) : new Date(0);
        const dateB = b.submit_time ? new Date(b.submit_time) : new Date(0);
        return dateB - dateA;
      });
      
      // 计算分页
      const totalPages = Math.ceil(filteredRequests.length / pageSize);
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
      
      // 更新记录计数
      document.getElementById('recordCount').textContent = filteredRequests.length + '条记录';
      
      // 更新分页按钮状态
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages || totalPages === 0;
      
      // 清空容器
      container.innerHTML = '';
      
      if (paginatedRequests.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <i class="fa fa-inbox text-4xl mb-3"></i>
            <p class="text-lg">暂无相关请假记录</p>
          </div>
        `;
        return;
      }
      
      // 渲染请假记录
      paginatedRequests.forEach(request => {
        const card = createLeaveCard(request);
        container.appendChild(card);
      });
    }

    // 创建请假卡片
    function createLeaveCard(request) {
      const card = document.createElement('div');
      card.className = 'border border-gray-100 rounded-lg p-4 hover:border-primary/30 transition-all';
      
      // 获取状态样式
      const statusClass = {
        '待审批': 'bg-warning/10 text-warning',
        '已批准': 'bg-success/10 text-success',
        '已驳回': 'bg-danger/10 text-danger'
      }[request.approval_status] || 'bg-gray-100 text-gray-500';
      
      // 计算请假天数
      let days = 0;
      if (request.start_time && request.end_time) {
        const start = new Date(request.start_time);
        const end = new Date(request.end_time);
        // 重置时间部分，只比较日期
        start.setHours(0, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        const diffTime = Math.abs(end - start);
        days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        // 如果是同一天，应为1天
        if (start.getTime() === end.getTime()) {
          days = 1;
        }
      }
      
      // 格式化时间显示
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('zh-CN');
      };
      
      const formatSubmitTime = (timeStr) => {
        if (!timeStr) return '';
        const date = new Date(timeStr);
        return date.toLocaleString('zh-CN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }).replace(/\//g, '-');
      };
      
      // 获取操作按钮
      let actionButton = '';
      if (request.approval_status === '待审批') {
        actionButton = `
          <div class="flex gap-2">
            <button class="text-sm bg-success/10 text-success px-3 py-1.5 rounded-lg hover:bg-success/20 transition-colors btn-hover" onclick="approveLeave('${request.leave_id}', '${request.student_name}')">
              批准
            </button>
            <button class="text-sm bg-danger/10 text-danger px-3 py-1.5 rounded-lg hover:bg-danger/20 transition-colors btn-hover" onclick="rejectLeave('${request.leave_id}', '${request.student_name}')">
              拒绝
            </button>
          </div>
        `;
      } else {
        actionButton = `
          <a href="#" class="text-sm bg-gray-100 text-gray-700 px-4 py-1.5 rounded-lg hover:bg-gray-200 transition-colors btn-hover" onclick="showDetails('${request.leave_id}')">
            查看详情
          </a>
        `;
      }
      
      // 设置卡片内容
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <h4 class="font-medium">${request.student_name || '未知学生'} - ${request.course_name || request.course_code || '未知课程'}</h4>
            <p class="text-sm text-gray-500 mt-1">学号: ${request.student_id || '未知学号'} | 请假类型: ${request.sort || '其他'}</p>
          </div>
          <span class="${statusClass} text-xs px-2 py-1 rounded-full">${request.approval_status || '未知状态'}</span>
        </div>
        <div class="mt-2 p-3 bg-gray-50 rounded-lg text-sm">
          <p class="mb-2"><span class="text-gray-500">请假时间:</span> ${formatDate(request.start_time)} 至 ${formatDate(request.end_time)} (共${days}天)</p>
          <p><span class="text-gray-500">请假理由:</span> ${request.leave_reason || '无'}</p>
        </div>
        <div class="mt-3 flex justify-between">
          <div>
            <button class="text-xs text-primary hover:underline flex items-center" onclick="viewAttachments('${request.leave_id}')">
              <i class="fa fa-paperclip mr-1"></i> 查看附件(${request.attachment_count || 0})
            </button>
          </div>
          <div>
            ${actionButton}
          </div>
        </div>
      `;
      
      return card;
    }

    // 批准请假
    async function approveLeave(leaveId, studentName) {
      if (confirm(`确定要批准学生 ${studentName} 的请假申请吗？`)) {
        try {
          const response = await fetch('/api/teacher/approve_leave', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ leave_id: leaveId, action: 'approve' })
          });
          const result = await response.json();
          
          if (result.success) {
            alert('批准成功');
            loadLeaveRequests(); // 重新加载数据
          } else {
            alert('批准失败: ' + result.message);
          }
        } catch (error) {
          console.error('批准请假失败:', error);
          alert('网络错误，请稍后重试');
        }
      }
    }
    
    // 拒绝请假
    async function rejectLeave(leaveId, studentName) {
      if (confirm(`确定要拒绝学生 ${studentName} 的请假申请吗？`)) {
        try {
          const response = await fetch('/api/teacher/approve_leave', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ leave_id: leaveId, action: 'reject' })
          });
          const result = await response.json();
          
          if (result.success) {
            alert('拒绝成功');
            loadLeaveRequests(); // 重新加载数据
          } else {
            alert('拒绝失败: ' + result.message);
          }
        } catch (error) {
          console.error('拒绝请假失败:', error);
          alert('网络错误，请稍后重试');
        }
      }
    }

    // 显示详情
    function showDetails(leaveId) {
      alert(`查看请假详情: ${leaveId}`);
      // 实际实现中应该跳转到详情页
      // window.location.href = `/teacher/detail/${leaveId}`;
    }

    // 查看附件
    function viewAttachments(leaveId) {
      alert(`查看请假附件: ${leaveId}`);
      // 实际实现中应该跳转到附件查看页或弹出附件列表
    }

    // 上一页
    function goToPrevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderLeaveRequests();
      }
    }

    // 下一页
    function goToNextPage() {
      const filteredRequests = getFilteredRequests();
      const totalPages = Math.ceil(filteredRequests.length / pageSize);
      
      if (currentPage < totalPages) {
        currentPage++;
        renderLeaveRequests();
      }
    }

    // 获取经过筛选的请求列表
    function getFilteredRequests() {
      let filteredRequests = [...allLeaveRequests];
      
      if (currentFilter !== 'all') {
        filteredRequests = filteredRequests.filter(req => req.approval_status === currentFilter);
      }
      
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      if (searchTerm) {
        filteredRequests = filteredRequests.filter(req => 
          (req.student_name && req.student_name.toLowerCase().includes(searchTerm)) ||
          (req.student_id && req.student_id.toLowerCase().includes(searchTerm))
        );
      }
      
      const selectedCourse = document.getElementById('courseSelect').value;
      if (selectedCourse) {
        filteredRequests = filteredRequests.filter(req => 
          req.course_name === selectedCourse
        );
      }
      
      return filteredRequests;
    }

    // 显示错误消息
    function showErrorMessage(message) {
      const container = document.getElementById('leaveListContainer');
      container.innerHTML = `
        <div class="text-center py-12 text-red-500">
          <i class="fa fa-exclamation-circle text-4xl mb-3"></i>
          <p class="text-lg">${message}</p>
        </div>
      `;
    }

    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>

</html>